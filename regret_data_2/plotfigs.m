clear;
close all;

mu_1 = 0.9;
mu_2 = 0.8;
q00 = 0.8;
q01 = 0.2;
q10 = 0.2;
q11 = 0.1;
% q00 = 1.0;
% q01 = 0.0;
% q10 = 0.0;
% q11 = 0.0;
V_star_1 = (mu_1 * (1 + q00 - mu_1 * q00 + mu_1 * q10 - q10))...
            /(q00 + mu_1 * (-2 * q00 + q10 + q01 + q11 * q00 - q10 * q01)...
              + mu_1 * mu_1 * (q00 + q11 - q10 - q01 - q11 * q00 + q10 * q01));
% V_star_1 = 7.418336391;
% V_star_1 = 99.00009918;
V_star_0 = ((1-mu_1*(1-q11))*V_star_1 - mu_1)/((1-mu_1)*(1-q10));
Q_star_1_a2 = mu_2 + (1-mu_2)*(1-q10)*V_star_0 + mu_2*(1-q11)*V_star_1;
upper_bound = 1/(2*(mu_1-mu_2)^2)*(V_star_1-Q_star_1_a2);
upper_bound_kl = 1/(mu_2*log(mu_2/mu_1)+(1-mu_2)*log((1-mu_2)/(1-mu_1)))*(V_star_1-Q_star_1_a2);

num_sims = 1e7;
K=2e4;
markers = {'o','^','v','d','x','*','s','>','<','+'};
colors = {[0.7, 0.7, 0.7], [0, 0, 0], [0, 0.8, 0], [0, 0, 0.8], [0.8, 0, 0], [0.8, 0.8, 0], [0, 0.8, 0.8]};

regret_ucb_mean = load('regret_data_3_0.707107_0.707107.txt');
regret_ucb_mean = regret_ucb_mean(1:K).';
regret_ucb_std = 1.96 * load('regret_data_std_3_0.707107_0.707107.txt') / sqrt(num_sims);
regret_ucb_std = regret_ucb_std(1:K).';
regret_ucb_mean_conf = [regret_ucb_mean+regret_ucb_std regret_ucb_mean(end:-1:1)-regret_ucb_std(end:-1:1)];

regret_kl_ucb_mean = load('regret_data_11_1.000000_1.000000.txt');
regret_kl_ucb_mean = regret_kl_ucb_mean(1:K).';
regret_kl_ucb_std = 1.96 * load('regret_data_std_11_1.000000_1.000000.txt') / sqrt(num_sims);
regret_kl_ucb_std = regret_kl_ucb_std(1:K).';
regret_kl_ucb_mean_conf = [regret_kl_ucb_mean+regret_kl_ucb_std regret_kl_ucb_mean(end:-1:1)-regret_kl_ucb_std(end:-1:1)];

regret_ulcb_mean = load('regret_data_1_-0.707107_0.707107.txt');
regret_ulcb_mean = regret_ulcb_mean(1:K).';
regret_ulcb_std = 1.96 * load('regret_data_std_1_-0.707107_0.707107.txt') / sqrt(num_sims);
regret_ulcb_std = regret_ulcb_std(1:K).';
regret_ulcb_mean_conf = [regret_ulcb_mean + regret_ulcb_std regret_ulcb_mean(end:-1:1)-regret_ulcb_std(end:-1:1)];

regret_kl_ulcb_mean = load('regret_data_4_1.000000_1.000000.txt');
regret_kl_ulcb_mean = regret_kl_ulcb_mean(1:K).';
regret_kl_ulcb_std = 1.96 * load('regret_data_std_4_1.000000_1.000000.txt') / sqrt(num_sims);
regret_kl_ulcb_std = regret_kl_ulcb_std(1:K).';
regret_kl_ulcb_mean_conf = [regret_kl_ulcb_mean + regret_kl_ulcb_std regret_kl_ulcb_mean(end:-1:1)-regret_kl_ulcb_std(end:-1:1)];

regret_q_learn_mean = load('regret_data_16_0.100000_0.100000.txt');
regret_q_learn_mean = regret_q_learn_mean(1:K).';
regret_q_learn_std = 1.96 * load('regret_data_std_16_0.100000_0.100000.txt') / sqrt(num_sims);
regret_q_learn_std = regret_q_learn_std(1:K).';
regret_q_learn_mean_conf = [regret_q_learn_mean + regret_q_learn_std regret_q_learn_mean(end:-1:1)-regret_q_learn_std(end:-1:1)];

regret_q_learn_ucb_mean = load('regret_data_17_4.000000_4.000000.txt');
regret_q_learn_ucb_mean = regret_q_learn_ucb_mean(1:K).';
regret_q_learn_ucb_std = 1.96 * load('regret_data_std_17_4.000000_4.000000.txt') / sqrt(num_sims);
regret_q_learn_ucb_std = regret_q_learn_ucb_std(1:K).';
regret_q_learn_ucb_mean_conf = [regret_q_learn_ucb_mean + regret_q_learn_ucb_std regret_q_learn_ucb_mean(end:-1:1)-regret_q_learn_ucb_std(end:-1:1)];


regret_ucbvi_mean = load('regret_data_19_7.000000_7.000000.txt');
regret_ucbvi_mean = regret_ucbvi_mean(1:K).';
regret_ucbvi_std = 1.96 * load('regret_data_std_19_7.000000_7.000000.txt') / sqrt(num_sims);
regret_ucbvi_std = regret_ucbvi_std(1:K).';
regret_ucbvi_mean_conf = [regret_ucbvi_mean + regret_ucbvi_std regret_ucbvi_mean(end:-1:1)-regret_ucbvi_std(end:-1:1)];


f1 = figure();
Ax(1) = axes(f1);
ylim([0,200])
xlim([1,K])
hold on;
grid on;
xlabel('K episodes (log scale)');
% ylabel('$E[\mathrm{Reg}_{\pi}(K)]$', 'interpreter', 'latex');
ylabel('Average total regret');
set(gca, 'FontSize', 14);

set(gca, 'XScale', 'log')
set(gca, 'XTick', [1, 10, 100, 1000, 10000]);
set(gca, 'YTick', 0:40:200);

num_points = 1e2;
x = unique(round(logspace(log10(1),log10(K),num_points)));
xconf = [x x(end:-1:1)];

% p1 = fill(xconf,regret_ucb_mean_conf,'red');
% p1.FaceColor = [1 0.6 0.6];
% p1.EdgeColor = 'none';
% p1.Annotation.LegendInformation.IconDisplayStyle = 'off';
% 
% p2 = fill(xconf,regret_kl_ucb_mean_conf,'magenta');
% p2.FaceColor = [1 0.6 1];
% p2.EdgeColor = 'none';
% p2.Annotation.LegendInformation.IconDisplayStyle = 'off';
% 
% p3 = fill(xconf,regret_ulcb_mean_conf,'green');
% p3.FaceColor = [0.6 1 0.6];
% p3.EdgeColor = 'none';
% p3.Annotation.LegendInformation.IconDisplayStyle = 'off';
% 
% p4 = fill(xconf,regret_kl_ulcb_mean_conf,'blue');
% p4.FaceColor = [0.6 0.6 1];
% p4.EdgeColor = 'none';
% p4.Annotation.LegendInformation.IconDisplayStyle = 'off';

y1 = semilogx(x, regret_q_learn_mean(x), 'color', colors{5}, 'linestyle', ':', 'linewidth', 1.5, 'Marker', markers{3}, 'MarkerIndices', 1:10:length(x));
y2 = semilogx(x, regret_q_learn_ucb_mean(x), 'color', colors{6}, 'linestyle', ':', 'linewidth', 1.5, 'Marker', markers{4}, 'MarkerIndices', 1:10:length(x));

y3 = semilogx(x, regret_ucb_mean(x), 'color', colors{3}, 'linestyle', ':', 'linewidth', 1.5, 'Marker', markers{1}, 'MarkerIndices', 1:10:length(x));
y4 = semilogx(x, regret_kl_ucb_mean(x), 'color', colors{4}, 'linestyle', ':', 'linewidth', 1.5, 'Marker', markers{2}, 'MarkerIndices', 1:10:length(x));

y5 = semilogx(x, regret_ulcb_mean(x), 'color', colors{3}, 'linestyle', '-', 'linewidth', 1.5, 'Marker', markers{1}, 'MarkerIndices', 1:10:length(x));
y6 = semilogx(x, regret_kl_ulcb_mean(x), 'color', colors{4}, 'linestyle', '-', 'linewidth', 1.5, 'Marker', markers{2}, 'MarkerIndices', 1:10:length(x));

y7 = semilogx(x, upper_bound*log(x), 'color', colors{3}, 'linestyle', '--', 'linewidth', 1.5, 'Marker', markers{1}, 'MarkerIndices', 1:10:length(x));
y8 = semilogx(x, upper_bound_kl*log(x), 'color', colors{4}, 'linestyle', '--', 'linewidth', 1.5, 'Marker', markers{2}, 'MarkerIndices', 1:10:length(x));

y9 = semilogx(x, regret_ucbvi_mean(x), 'color', colors{7}, 'linestyle', ':', 'linewidth', 1.5, 'Marker', markers{5}, 'MarkerIndices', 1:10:length(x));


set(Ax(1), 'Box','off')

lgd1 = legend(Ax(1), [y1 y2 y9], 'Q-learning with \epsilon=0.1', 'Q-learning with UCB', 'UCBVI');

Ax(2)=axes('position',get(gca,'position'),'visible','off','FontSize', 14);

lgd2 = legend(Ax(2), [y3 y4 y5 y6 y7 y8], 'UCB', 'KL-UCB','ULCB', 'KL-ULCB', 'UB for ULCB', ['UB for KL-ULCB' newline 'LB for MAB-A']);

% legend('Q-learning with \epsilon=0.1', 'Q-learning with UCB', 'UCB', 'KL-UCB', 'ULCB', 'KL-ULCB', 'UB for ULCB', ['UB for KL-ULCB' newline 'LB for MAB-A']);



